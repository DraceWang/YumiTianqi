package com.boyumi.yumitianqi;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.URL;
import java.net.URLConnection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.xmlpull.v1.XmlPullParser;
import org.xmlpull.v1.XmlPullParserFactory;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.content.Context;
import android.content.res.XmlResourceParser;
import android.widget.Toast;

public class YahooWeather {

	private String Woeid;
	private String WeatherCondition;
	private String Temperature;
	private String Date;
	private String CityName;
	private int WeatherCode;
	private List<Map<String, Object>> ForecastList = new ArrayList<Map<String, Object>>();
	
	public YahooWeather(String cityname){
		setCityName(cityname);
	}

	public String getWoeid() {
		return Woeid;
	}

	public void setWoeid(String woeid) {
		Woeid = woeid;
	}

	public String getWeatherCondition() {
		return WeatherCondition;
	}

	public void setWeatherCondition(String weatherCondition) {
		WeatherCondition = weatherCondition;
	}

	public String getTemperature() {
		return Temperature;
	}

	public void setTemperature(String temperature) {
		Temperature = temperature;
	}

	public String getDate() {
		return Date;
	}

	public void setDate(String date) {
		Date = date;
	}

	public String getCityName() {
		return CityName;
	}

	public void setCityName(String cityName) {
		CityName = cityName;
	}

	public int getWeatherCode() {
		return WeatherCode;
	}

	public void setWeatherCode(int weatherCode) {
		WeatherCode = weatherCode;
	}

	public List<Map<String, Object>> getForecastList() {
		return ForecastList;
	}

	public void setForecastList(List<Map<String, Object>> forecastList) {
		ForecastList = forecastList;
	}

	
	public void getWeather(Context context, String cityname) {
		if (cityname == null) {
			setWeatherCode(99);
			System.out.println("error:" + "didn't get a cityname!!");
			return;
		}
		getWoeid(cityname,context);
		final String url = "http://weather.yahooapis.com/forecastrss?w="
				+ Woeid + "&u=c";
		Thread gw = new Thread() {
			@Override
			public void run() {
				// TODO Auto-generated method stub
				super.run();
				try {
					URLConnection con = (URLConnection) (new URL(url))
							.openConnection();
					con.setRequestProperty("accept", "*/*");
					con.setRequestProperty("connection", "Keep-Alive");
					con.setRequestProperty("user-agent",
							"Mozilla/4.0(compatible;MSIE 6.0;Windows NT 5.1;SV1)");
					con.connect();
					System.out.println("connected");
					XmlPullParser parser = XmlPullParserFactory.newInstance()
							.newPullParser();
					parser.setInput(new InputStreamReader(con.getInputStream()));

					while (parser.getEventType() != XmlResourceParser.END_DOCUMENT) {
						//begin to analysis the return data
						if (parser.getEventType() == XmlResourceParser.START_TAG) {
							String tagName = parser.getName();
							//current weather
							if (tagName.equals("yweather:condition")) {
								System.out.println("pulling the weatherIfno");
								// WeatherCondition = parser.getAttributeValue(
								// null, "text");
								Temperature = parser.getAttributeValue(null,
										"temp");
								Temperature += ("\u2103");
								WeatherCode = Integer.valueOf(parser
										.getAttributeValue(null, "code"));
								Date = parser.getAttributeValue(null, "date");
							}

							// forecast weather
							for (int i = 1; i < 6; i++) {
								if (tagName.equals("yweather:forecast")) {
											String day = transfer_day_display(parser
													.getAttributeValue(null,
															"day"));
											String weather = weathercodedisplay(Integer.valueOf(parser.getAttributeValue(null,
													"code")));
											String temprang = parser.getAttributeValue(null,
													"low")
													+ "-"
													+ parser.getAttributeValue(
															null, "high") ;
									Map<String, Object> listItem = new HashMap<String, Object>();
									listItem.put("day",day);
									listItem.put("weather",weather);
									listItem.put("temprang",temprang);
									ForecastList.add(listItem);
									System.out.println(ForecastList.get(i-1).toString());
								}
							}

						}
						parser.next();
					}

				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		};
		gw.start();
		try {
			gw.join();
		} catch (InterruptedException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		if (Date == null) {
			Toast.makeText(context, "ÎÞ·¨»ñÈ¡ÍøÂçÌìÆø", 5000);
		return;
		}
		System.out.println("pulling Weather -----Done");
	}

	public void getWoeid(String cityname,Context context) {
		try {
			InputStream in = context.getResources().getAssets().open("woeid.txt");
			InputStreamReader read = new InputStreamReader(in, "UTF-8");
			BufferedReader br = new BufferedReader(read);
			String tempLine;
			while ((tempLine = br.readLine()) != null) {
				String[] tmp = tempLine.split("\\|");
				if (cityname.equals(tmp[0])) {
					setWoeid(tmp[1]);
					System.out.println(cityname+": find it's woeid------" + Woeid);
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	public String transfer_day_display(String day) {
		switch (day) {
		case "Mon":
			return "ÐÇÆÚÒ»";
		case "Tue":
			return "ÐÇÆÚ¶þ";
		case "Wed":
			return "ÐÇÆÚÈý";
		case "Thu":
			return "ÐÇÆÚËÄ";
		case "Fri":
			return "ÐÇÆÚÎå";
		case "Sat":
			return "ÐÇÆÚÁù";
		case "Sun":
			return "ÐÇÆÚÌì";
		default:
			return null;
		}
	}

	public String weathercodedisplay(int WeatherCode) {
		switch (WeatherCode) {
		case 0:
		case 1:
		case 2:
			return "·ç±©";
		case 3:
		case 4:
		case 37:
		case 38:
		case 39:
		case 45:
		case 46:
		case 47:
			return "À×ÕóÓê";
		case 5:
		case 6:
		case 7:
		case 35:
		case 17:
			return  "Óê¼ÐÑ©";
		case 8:
		case 9:
		case 10:
		case 11:
		case 12:
		case 18:
		case 40:
			return "ÕóÓê";
		case 13:
		case 14:
		case 15:
		case 16:
		case 41:
		case 42:
		case 43:
			return  "Ñ©";
		case 19:
		case 20:
		case 22:
			return "Îí";
		case 23:
		case 24:
		case 25:
			return "·ç";
		case 26:
		case 27:
		case 29:
		case 30:
		case 44:
			return"¾Ö²¿¶àÔÆ";
		case 31:
		case 32:
		case 33:
		case 34:
		case 36:
		case 28:
		case 21:
			return "Çç";
		default:
			return null;
		}
	}
}
